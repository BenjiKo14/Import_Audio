<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Extraction MP3 YouTube</title>
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      background-color: #fff;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
      width: 100%;
      max-width: 500px;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .timing-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 20px;
    }

    .timing-group {
      flex: 1;
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    .timing-group h3 {
      margin: 0 0 15px 0;
      color: #495057;
      font-size: 16px;
    }

    .time-controls {
      display: flex;
      justify-content: center;
      gap: 5px;
      align-items: center;
    }

    .time-unit {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .time-unit label {
      font-size: 10px;
      color: #6c757d;
      font-weight: bold;
    }

    .time-input {
      width: 35px;
      height: 25px;
      text-align: center;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      background-color: white;
    }

    .time-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.25);
    }



    .time-separator {
      font-size: 14px;
      font-weight: bold;
      color: #6c757d;
      margin: 0 3px;
    }

    .quick-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .quick-btn {
      padding: 5px 10px;
      border: 1px solid #007bff;
      background-color: white;
      color: #007bff;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-btn:hover {
      background-color: #007bff;
      color: white;
    }

    button {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    .spinner {
      display: none;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #28a745;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      display: none;
      margin-top: 20px;
    }

    .progress-bar {
      width: 100%;
      background-color: #eee;
      border-radius: 5px;
      overflow: hidden;
      height: 20px;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background-color: #28a745;
      text-align: center;
      color: white;
      line-height: 20px;
      font-size: 12px;
      transition: width 0.3s ease;
    }

    .success-message {
      color: green;
      font-weight: bold;
      margin-top: 20px;
      font-size: 18px;
      display: none;
      animation: pop-in 0.3s ease-in-out;
    }

    @keyframes pop-in {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .error-message {
      color: red;
      font-weight: bold;
      margin-top: 20px;
    }

    #status-text {
      font-weight: bold;
      margin-top: 15px;
    }

    .download-btn {
      display: inline-block;
      text-decoration: none;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      padding: 10px 20px;
      margin-top: 20px;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .download-btn:hover {
      background-color: #0056b3;
      text-decoration: none;
    }
    .download-btn:link,
    .download-btn:visited,
    .download-btn:hover,
    .download-btn:active {
      text-decoration: none;
      color: #fff;
    }

    .mode-selector {
      margin-bottom: 20px;
      display: inline-block;
      width: auto;
      min-width: 200px;
      text-align: center;
    }

    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: white;
      font-size: 14px;
      text-align: center;
      text-align-last: center;
    }

    select option {
      text-align: center;
    }

    input[type="file"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Extraction Audio</h1>

    <form id="extract-form">
      <div class="mode-selector">
        <label>Source :</label><br>
        <select name="mode" id="mode-select" required>
          <option value="youtube">Lien YouTube</option>
          <option value="upload">Upload de fichier</option>
        </select>
      </div>

      <div id="youtube-input">
        <label for="url">Lien YouTube :</label><br>
        <input type="text" name="url"><br>
      </div>

      <div id="file-input" style="display: none;">
        <label for="audio-file">Fichier audio :</label><br>
        <input type="file" name="audio-file" accept="audio/*"><br>
      </div>

      <div class="timing-row">
        <div class="timing-group">
          <h3>‚è∞ D√©but</h3>
                     <div class="time-controls">
             <div class="time-unit">
               <label>Heures</label>
               <input type="number" class="time-input" id="start-hours" min="0" max="23" value="0">
             </div>
             <span class="time-separator">:</span>
             <div class="time-unit">
               <label>Minutes</label>
               <input type="number" class="time-input" id="start-minutes" min="0" max="59" value="0">
             </div>
             <span class="time-separator">:</span>
             <div class="time-unit">
               <label>Secondes</label>
               <input type="number" class="time-input" id="start-seconds" min="0" max="59" value="0">
             </div>
           </div>
                     <div class="quick-actions">
             <button type="button" class="quick-btn" onclick="setQuickTime('start', 0)">0:00</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('start', 30)">0:30</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('start', 60)">1:00</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('start', 300)">5:00</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('start', 4500)">1:15:00</button>
           </div>
        </div>

        <div class="timing-group">
          <h3>‚èπÔ∏è Fin</h3>
                     <div class="time-controls">
             <div class="time-unit">
               <label>Heures</label>
               <input type="number" class="time-input" id="end-hours" min="0" max="23" value="1">
             </div>
             <span class="time-separator">:</span>
             <div class="time-unit">
               <label>Minutes</label>
               <input type="number" class="time-input" id="end-minutes" min="0" max="59" value="0">
             </div>
             <span class="time-separator">:</span>
             <div class="time-unit">
               <label>Secondes</label>
               <input type="number" class="time-input" id="end-seconds" min="0" max="59" value="0">
             </div>
           </div>
                     <div class="quick-actions">
             <button type="button" class="quick-btn" onclick="setQuickTime('end', 30)">0:30</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('end', 60)">1:00</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('end', 300)">5:00</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('end', 600)">10:00</button>
             <button type="button" class="quick-btn" onclick="setQuickTime('end', 5400)">1:30:00</button>
           </div>
        </div>
      </div>

      <!-- Champs cach√©s pour les valeurs de temps -->
      <input type="hidden" name="start" id="start-time" value="0:0:0">
      <input type="hidden" name="end" id="end-time" value="1:0:0">

      <button type="submit" id="extract-btn">Extraire</button>
    </form>

    <div id="spinner" class="spinner"></div>

    <div class="progress-container" id="progress-container">
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progress-bar-fill">0%</div>
      </div>
    </div>

    <p id="status-text"></p>

    <p class="success-message" id="success-message">
      ‚úÖ Traitement termin√© ! <br>
      <a href="/download" class="download-btn">üéß T√©l√©charger le fichier MP3</a>
    </p>

    <p class="error-message" id="error-message" style="display:none;"></p>
  </div>

  <script>
    const form = document.getElementById("extract-form");
    const button = document.getElementById("extract-btn");
    const spinner = document.getElementById("spinner");
    const progressContainer = document.getElementById("progress-container");
    const progressFill = document.getElementById("progress-bar-fill");
    const statusText = document.getElementById("status-text");
    const successMsg = document.getElementById("success-message");
    const errorMsg = document.getElementById("error-message");
    const modeSelect = document.getElementById("mode-select");
    const youtubeInput = document.getElementById("youtube-input");
    const fileInput = document.getElementById("file-input");
    const urlInput = document.querySelector('input[name="url"]');

    let progressInterval;
    let statusInterval;

    // Heartbeat vers /ping pour garder le serveur vivant
    let pingTimer = setInterval(() => {
      fetch("/ping", { method: "POST" }).catch(() => {});
    }, 5000);

    window.addEventListener("beforeunload", () => {
      clearInterval(pingTimer);
    });

    // Fonction pour r√©initialiser l'interface
    function resetUI() {
      spinner.style.display = "none";
      progressContainer.style.display = "none";
      button.disabled = false;
      clearInterval(progressInterval);
      clearInterval(statusInterval);
    }

    // V√©rification du mode au chargement de la page
    function updateInputVisibility() {
      if (modeSelect.value === 'youtube') {
        youtubeInput.style.display = 'block';
        fileInput.style.display = 'none';
        urlInput.required = true;
      } else {
        youtubeInput.style.display = 'none';
        fileInput.style.display = 'block';
        urlInput.required = false;
      }
    }

    // Appeler la fonction au chargement
    updateInputVisibility();



    function setQuickTime(type, seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      document.getElementById(`${type}-hours`).value = hours;
      document.getElementById(`${type}-minutes`).value = minutes;
      document.getElementById(`${type}-seconds`).value = secs;
      
      updateHiddenTimeFields();
    }

    function updateHiddenTimeFields() {
      const startHours = document.getElementById('start-hours').value || 0;
      const startMinutes = document.getElementById('start-minutes').value || 0;
      const startSeconds = document.getElementById('start-seconds').value || 0;
      
      const endHours = document.getElementById('end-hours').value || 0;
      const endMinutes = document.getElementById('end-minutes').value || 0;
      const endSeconds = document.getElementById('end-seconds').value || 0;
      
      document.getElementById('start-time').value = `${startHours}:${startMinutes}:${startSeconds}`;
      document.getElementById('end-time').value = `${endHours}:${endMinutes}:${endSeconds}`;
    }

    // Ajouter des √©couteurs d'√©v√©nements pour les champs de saisie
    document.querySelectorAll('.time-input').forEach(input => {
      input.addEventListener('input', updateHiddenTimeFields);
      input.addEventListener('change', updateHiddenTimeFields);
    });

    // Initialiser les champs cach√©s
    updateHiddenTimeFields();

    modeSelect.addEventListener('change', function() {
      updateInputVisibility();
    });

    function startProgressPoll() {
      progressInterval = setInterval(() => {
        fetch("/progress")
          .then(res => res.json())
          .then(data => {
            const percent = data.percent;

            if (percent !== "0%" && percent !== "convert" && percent !== "done") {
              spinner.style.display = "none";
              progressContainer.style.display = "block";
              progressFill.style.width = percent;
              progressFill.innerText = percent;
            } else {
              progressContainer.style.display = "none";
              progressFill.style.width = "0%";
              progressFill.innerText = "0%";
              spinner.style.display = "block";
            }
          });
      }, 500);
    }

    function startStatusPoll() {
      statusInterval = setInterval(() => {
        fetch("/status")
          .then(res => res.json())
          .then(data => {
            statusText.innerText = data.step;
          });
      }, 500);
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData();
      const mode = modeSelect.value;
      
      if (mode === 'youtube') {
        formData.append('url', urlInput.value);
      } else {
        const fileInput = document.querySelector('input[name="audio-file"]');
        if (fileInput.files.length > 0) {
          formData.append('audio-file', fileInput.files[0]);
        } else {
          alert('Veuillez s√©lectionner un fichier audio');
          return;
        }
      }
      
      formData.append('start', document.querySelector('input[name="start"]').value);
      formData.append('end', document.querySelector('input[name="end"]').value);
      formData.append('mode', mode);

      // R√©initialiser l'affichage
      spinner.style.display = "block";
      progressContainer.style.display = "none";
      successMsg.style.display = "none";
      errorMsg.style.display = "none";
      button.disabled = true;

      // D√©marrer le polling
      startProgressPoll();
      startStatusPoll();

      fetch("/extract", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        resetUI();

        if (data.success) {
          successMsg.style.display = "block";
          statusText.innerText = "‚úÖ Fichier pr√™t √† √™tre t√©l√©charg√© !";
          // Mettre √† jour le lien de t√©l√©chargement avec le nom de fichier
          const downloadLink = document.querySelector('.download-btn');
          downloadLink.href = `/download?filename=${encodeURIComponent(data.filename)}`;
          
          // ‚¨áÔ∏è D√âCLENCHEMENT AUTO DU T√âL√âCHARGEMENT
          downloadLink.click();
          
          // Notifier le serveur que le t√©l√©chargement commence
          fetch("/download-start", { method: "POST" }).catch(() => {});
          
          // Continuer les pings pendant le t√©l√©chargement
          let downloadPingInterval = setInterval(() => {
            fetch("/ping", { method: "POST" }).catch(() => {});
          }, 2000); // Ping toutes les 2 secondes pendant le t√©l√©chargement
          
          // Arr√™ter les pings de t√©l√©chargement apr√®s 5 minutes
          setTimeout(() => {
            clearInterval(downloadPingInterval);
          }, 300000); // 5 minutes
        } else {
          errorMsg.innerText = "Erreur : " + data.error;
          errorMsg.style.display = "block";
        }
      })
      .catch(err => {
        resetUI();
        errorMsg.innerText = "Erreur r√©seau : " + err.message;
        errorMsg.style.display = "block";
      });
    });
  </script>
</body>
</html>
